image: eldeibiz/sfdxci:0.3
pipelines:
  default: #These commands run for all branches unless specified otherwise
    - step: &diff_package
        name: "Default pipeline"
        script:
          - echo "BITBUCKET_BRANCH=$BITBUCKET_BRANCH  -  BITBUCKET_TAG=$BITBUCKET_TAG  -  BITBUCKET_PR_DESTINATION_BRANCH=$BITBUCKET_PR_DESTINATION_BRANCH  -  BITBUCKET_DEPLOYMENT_ENVIRONMENT?$BITBUCKET_DEPLOYMENT_ENVIRONMENT"
          - pwd # Typical bitbucket dir: /opt/atlassian/pipelines/agent/build
          - git fetch origin
          - git checkout "${BITBUCKET_PR_DESTINATION_BRANCH:-dev}"
  branches :
    'feature/*':
      - step:
          name: "Branch pipeline for features"
          script:
          - echo "BITBUCKET_BRANCH=$BITBUCKET_BRANCH  -  BITBUCKET_TAG=$BITBUCKET_TAG  -  BITBUCKET_PR_DESTINATION_BRANCH=$BITBUCKET_PR_DESTINATION_BRANCH   -  BITBUCKET_DEPLOYMENT_ENVIRONMENT?$BITBUCKET_DEPLOYMENT_ENVIRONMENT"
          - pwd # Typical bitbucket dir: /opt/atlassian/pipelines/agent/build
          - sgd --to HEAD --from HEAD^ --repo . --output ./delta
          - cat ./delta/package/package.xml          
          - TRUNK_REGEXP="^(dev|int|uat|pre|hot|pro)$"
          - git fetch origin
          - git checkout "${BITBUCKET_PR_DESTINATION_BRANCH:-dev}"
          - git show-branch
          - git checkout $BITBUCKET_BRANCH
          - git show-branch | head -n30
          - CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          - PARENT_BRANCH=$(git show-branch | grep '^[^\[]*\*' | sed 's/.*\[\(.*\)\].*/\1/' | sed 's/[\^~].*//' | grep -v "$CURRENT_BRANCH" | head -n1)
          - PARENT_TRUNK=$(git show-branch | grep '^[^\[]*\*' | sed 's/.*\[\(.*\)\].*/\1/' | sed 's/[\^~].*//' | grep -E "$TRUNK_REGEXP" | head -n1)
          - DESTINATION_BRANCH=${BITBUCKET_PR_DESTINATION_BRANCH:-$PARENT_TRUNK}
          - COMMIT_ANCESTOR=$(git merge-base --octopus HEAD $DESTINATION_BRANCH)
          - echo "CURRENT_BRANCH=$CURRENT_BRANCH  -  PARENT_BRANCH=$PARENT_BRANCH  -  PARENT_TRUNK=$PARENT_TRUNK  -  DESTINATION_BRANCH=$DESTINATION_BRANCH  -  COMMIT_ANCESTOR=$COMMIT_ANCESTOR"
          - mkdir -p delta; sgd --to HEAD --from $COMMIT_ANCESTOR --repo . --output ./delta
          - cat delta/package/package.xml
          - cat delta/destructiveChanges/destructiveChanges.xml
    dev:
      - step:
          name: "Branch pipeline for dev"
          script:
          - echo "BITBUCKET_BRANCH=$BITBUCKET_BRANCH  -  BITBUCKET_TAG=$BITBUCKET_TAG  -  BITBUCKET_PR_DESTINATION_BRANCH=$BITBUCKET_PR_DESTINATION_BRANCH   -  BITBUCKET_DEPLOYMENT_ENVIRONMENT?$BITBUCKET_DEPLOYMENT_ENVIRONMENT"
          - pwd # Typical bitbucket dir: /opt/atlassian/pipelines/agent/build
          - TRUNK_REGEXP="^(dev|int|uat|pre|hot|pro)$"
          - git fetch origin
          - git checkout "${BITBUCKET_PR_DESTINATION_BRANCH:-dev}"
          - git show-branch
          - git checkout $BITBUCKET_BRANCH
          - git show-branch | head -n30
          - CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          - PARENT_BRANCH=$(git show-branch | grep '^[^\[]*\*' | sed 's/.*\[\(.*\)\].*/\1/' | sed 's/[\^~].*//' | grep -v "$CURRENT_BRANCH" | head -n1)
          - PARENT_TRUNK=$(git show-branch | grep '^[^\[]*\*' | sed 's/.*\[\(.*\)\].*/\1/' | sed 's/[\^~].*//' | grep -E "$TRUNK_REGEXP" | head -n1)
          - DESTINATION_BRANCH=${BITBUCKET_PR_DESTINATION_BRANCH:-$PARENT_TRUNK}
          - COMMIT_ANCESTOR=$(git merge-base --octopus HEAD $DESTINATION_BRANCH)
          - echo "CURRENT_BRANCH=$CURRENT_BRANCH  -  PARENT_BRANCH=$PARENT_BRANCH  -  PARENT_TRUNK=$PARENT_TRUNK  -  DESTINATION_BRANCH=$DESTINATION_BRANCH  -  COMMIT_ANCESTOR=$COMMIT_ANCESTOR"
          - mkdir -p delta; sgd --to HEAD --from $COMMIT_ANCESTOR --repo . --output ./delta
          - cat delta/package/package.xml
          - cat delta/destructiveChanges/destructiveChanges.xml
        
  pull-requests:
    'feature/*': # Pull request from feature branch to Trunk
      - step:
          name: "Trunk Pull Request Validate Package"
          script:
          - echo "BITBUCKET_BRANCH=$BITBUCKET_BRANCH  -  BITBUCKET_TAG=$BITBUCKET_TAG  -  BITBUCKET_PR_DESTINATION_BRANCH=$BITBUCKET_PR_DESTINATION_BRANCH  -  BITBUCKET_DEPLOYMENT_ENVIRONMENT?$BITBUCKET_DEPLOYMENT_ENVIRONMENT"
          - pwd # Typical bitbucket dir: /opt/atlassian/pipelines/agent/build
          - TRUNK_REGEXP="^(dev|int|uat|pre|hot|pro)$"
          - git fetch origin
          - git checkout "${BITBUCKET_PR_DESTINATION_BRANCH:-dev}"
          - git show-branch
          - git checkout $BITBUCKET_BRANCH
          - git show-branch | head -n30
          - CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          - PARENT_BRANCH=$(git show-branch | grep '^[^\[]*\*' | sed 's/.*\[\(.*\)\].*/\1/' | sed 's/[\^~].*//' | grep -v "$CURRENT_BRANCH" | head -n1)
          - PARENT_TRUNK=$(git show-branch | grep '^[^\[]*\*' | sed 's/.*\[\(.*\)\].*/\1/' | sed 's/[\^~].*//' | grep -E "$TRUNK_REGEXP" | head -n1)
          - DESTINATION_BRANCH=${BITBUCKET_PR_DESTINATION_BRANCH:-$PARENT_TRUNK}
          - COMMIT_ANCESTOR=$(git merge-base --octopus HEAD $DESTINATION_BRANCH)
          - echo "CURRENT_BRANCH=$CURRENT_BRANCH  -  PARENT_BRANCH=$PARENT_BRANCH  -  PARENT_TRUNK=$PARENT_TRUNK  -  DESTINATION_BRANCH=$DESTINATION_BRANCH  -  COMMIT_ANCESTOR=$COMMIT_ANCESTOR"
          - mkdir -p delta; sgd --to HEAD --from $COMMIT_ANCESTOR --repo . --output ./delta
          - cat delta/package/package.xml
          - cat delta/destructiveChanges/destructiveChanges.xml

          # By default, the CLI periodically checks for and installs updates.
          # Disable (true) this auto-update check to improve performance of CLI commands.
          - export SFDX_AUTOUPDATE_DISABLE=true

          # Specifies the time, in seconds, that the CLI waits for the Lightning Experience custom domain to resolve and become available in a newly-created scratch org.
          # If you get errors about My Domain not configured when you try to use a newly-created scratch org, increase this wait time.
          - export SFDX_DOMAIN_RETRY=300

          # For force:package:create, disables automatic updates to the sfdx-project.json file.
          - export SFDX_PROJECT_AUTOUPDATE_DISABLE_FOR_PACKAGE_CREATE=true

          # For force:package:version:create, disables automatic updates to the sfdx-project.json file.
          - export SFDX_PROJECT_AUTOUPDATE_DISABLE_FOR_PACKAGE_VERSION_CREATE=true

          - export TESTLEVEL=RunLocalTests

          # Current variables
          - echo $SFDC_PRO_URL
          - echo $SFDC_PRO_USER

          # Output CLI version and plug-in information
          - sfdx --version
          - sfdx plugins --core

          #Decrypt server key
          - openssl enc -nosalt -aes-256-cbc -d -in /assets/server.key.enc -out server.key -base64 -K $DECRYPTION_KEY -iv $DECRYPTION_IV

          - cat delta/package/package.xml

          - sfdx force:auth:jwt:grant --clientid $CONSUMER_KEY --username $SFDC_PRO_USER --jwtkeyfile server.key --setdefaultdevhubusername --setalias sfdx-ci --instanceurl $SFDC_PRO_URL
          - sfdx force:limits:api:display -u $SFDC_PRO_USER
          - sfdx force:source:convert -d mdapi

          - | # Show computed package
            [ -f mdapi/package.xml ] && cat mdapi/package.xml
          - sfdx force:mdapi:deploy -d mdapi -u $SFDC_PRO_USER -w 30 --testlevel $TESTLEVEL --checkonly
          after-script:
          - sfdx auth:logout --all --noprompt
